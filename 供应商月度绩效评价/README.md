# 供应商绩效评价模块

## 概述

供应商绩效评价模块是一个功能完整的企业级供应商管理子系统，用于对供应商进行周期性的绩效评估。系统支持月度、季度、年度等多种评价周期，涵盖质量、交付、服务等多个评价维度，并提供直观的统计看板和趋势分析功能。

本模块与IQC（来料检验）数据联动，自动提取供应商的质量数据作为评价参考，实现评价过程的自动化和标准化。

---

## 系统架构

### 技术栈

- **前端**：原生JavaScript + HTML5 + CSS3
- **后端**：Node.js + Express
- **数据库**：SQLite（Sequelize ORM）
- **图表**：Chart.js

### 目录结构

```
项目根目录/
├── public/                          # 前端资源
│   ├── js/modules/
│   │   ├── performance.js           # 评价执行模块
│   │   ├── performance-dashboard.js # 仪表盘展示模块
│   │   └── performance-config.js    # 配置管理模块
│   ├── css/modules/
│   │   ├── performance-evaluation.css
│   │   ├── performance-dashboard.css
│   │   └── performance-config.css
│   └── index.html
│
├── server/                          # 后端服务
│   ├── models/
│   │   ├── PerformanceEvaluation.js       # 评价周期模型
│   │   ├── PerformanceEvaluationDetail.js  # 评价详情模型
│   │   ├── VendorConfig.js                 # 供应商配置模型
│   │   └── IQCData.js                      # IQC数据模型
│   ├── routes/
│   │   ├── evaluations.js           # 评价API路由
│   │   └── evaluation-config.js     # 配置API路由
│   ├── services/
│   │   ├── performance-evaluation-service.js  # 评价业务逻辑
│   │   ├── evaluation-config-service.js      # 配置管理服务
│   │   └── quality-data-extraction-service.js # IQC数据提取
│   └── index.js
│
└── data/
    └── evaluation-config.json         # 评价配置文件
```

---

## 核心概念

### 1. 评价周期（Evaluation Period）

评价周期是进行供应商绩效评价的时间范围，定义了一次评价的时间跨度。

| 字段 | 类型 | 说明 |
|------|------|------|
| period_name | STRING | 周期名称，如"2025年1月"、"2025年Q1" |
| period_type | ENUM | 周期类型：monthly(月度)、quarterly(季度)、yearly(年度)、custom(自定义) |
| start_date | DATE | 开始日期 |
| end_date | DATE | 结束日期 |
| status | ENUM | 状态：draft(草稿)、in_progress(进行中)、completed(已完成) |
| config_snapshot | JSON | 配置快照，保存创建时的评价配置 |

**重要特性**：每次创建评价周期时会保存当前配置快照（config_snapshot），这意味着历史评价不会因为后续配置变更而受到影响，保证了评价数据的稳定性和可追溯性。

### 2. 评价详情（Evaluation Detail）

评价详情记录了每个供应商在特定评价周期中的具体得分和等级。

| 字段 | 类型 | 说明 |
|------|------|------|
| evaluation_id | INTEGER | 所属评价周期ID |
| evaluation_entity_name | STRING | 供应商名称 |
| data_type | ENUM | 数据类型：purchase(外购)、external(外协) |
| scores | JSON | 各维度分数，如 `{"quality": 90, "delivery": 85, "service": 88}` |
| total_score | DECIMAL(5,2) | 总分（0-100） |
| grade | STRING | 等级：优秀、合格、整改后合格、不合格 |
| remarks | TEXT | 评价备注 |
| quality_data_snapshot | JSON | 质量数据快照（总批次、合格批次、合格率） |

### 3. 评价维度与权重

评价维度定义了从哪些方面对供应商进行评估，权重决定了各维度在总分中的占比。

**默认配置（可在管理界面修改）**：

| 维度 | 键名 | 权重 |
|------|------|------|
| 质量 | quality | 0.5 (50%) |
| 交付 | delivery | 0.3 (30%) |
| 服务 | service | 0.2 (20%) |

**总分计算公式**：
```
总分 = quality×0.5 + delivery×0.3 + service×0.2
```

### 4. 等级规则

等级规则定义了如何根据总分确定供应商等级。

**默认规则**：

| 等级 | 分数范围 |
|------|----------|
| 优秀 | 95-100 |
| 合格 | 85-94.99 |
| 整改后合格 | 70-84.99 |
| 不合格 | 0-69.99 |

---

## 功能模块

### 模块一：绩效评价执行（Performance Module）

**文件**：`public/js/modules/performance.js`

**职责**：
- 创建新的评价周期
- 加载待评价的供应商列表
- 执行供应商评分
- 提交评价结果

**核心流程**：

```
1. 选择周期类型 → 2. 设置日期范围 → 3. 创建评价周期
4. 开始评价 → 5. 为每个供应商评分 → 6. 提交评价
```

**关键函数**：

| 函数 | 功能 |
|------|------|
| `init()` | 模块初始化 |
| `loadDashboard()` | 加载主界面数据 |
| `createEvaluation()` | 创建新评价周期 |
| `startEvaluation()` | 开始评价（提取IQC数据） |
| `saveEntityEvaluation()` | 保存单个供应商评价 |
| `submitEvaluation()` | 提交整个评价周期 |

**质量数据联动**：
当开始一个新的评价周期时，系统会自动从IQCData表提取对应时间范围内的质量数据：
- 总批次数量
- 合格批次数量
- 不合格批次数量
- 合格率

这些数据会作为"质量数据快照"保存到评价详情中，供评分时参考。

---

### 模块二：绩效仪表盘（Performance Dashboard）

**文件**：`public/js/modules/performance-dashboard.js`

**职责**：
- 展示年度累计评价结果
- 统计各等级供应商数量
- 热力图展示（年度排名）
- 趋势图表分析
- 年度数据汇总

**核心功能**：

1. **年份选择**：支持选择查看不同年份的数据
2. **类型切换**：外购 / 外协 数据分离显示
3. **等级统计**：优秀、合格、整改后合格、不合格各有多少供应商
4. **热力图**：按月份展示各供应商的等级（颜色编码）
5. **趋势图**：展示平均分、各等级数量的月度变化趋势

**关键函数**：

| 函数 | 功能 |
|------|------|
| `loadAccumulatedResults(year, type)` | 加载年度累计数据 |
| `renderStats()` | 渲染统计数据 |
| `renderHeatmap()` | 渲染热力图 |
| `renderCharts()` | 渲染趋势图表 |
| `getScoreColor(score)` | 根据分数获取颜色 |

---

### 模块三：配置管理（Performance Config）

**文件**：`public/js/modules/performance-config.js`

**职责**：
- 管理评价维度配置（增删改查）
- 设置各维度权重
- 配置等级规则
- 预览配置效果

**配置界面功能**：
- 维度管理：添加、删除、修改评价维度
- 权重设置：调整各维度权重（总和必须为100%）
- 等级规则：设置各等级的分数区间
- 颜色配置：为各等级设置显示颜色

---

## API接口

### 评价周期管理

| 方法 | 路径 | 功能 |
|------|------|------|
| POST | `/api/evaluations` | 创建评价周期 |
| GET | `/api/evaluations` | 获取所有评价周期 |
| GET | `/api/evaluations/:id` | 获取指定评价周期详情 |
| DELETE | `/api/evaluations/:id` | 删除评价周期 |
| POST | `/api/evaluations/:id/start` | 开始/继续评价 |
| PUT | `/api/evaluations/:id/submit` | 提交评价 |

### 评价执行

| 方法 | 路径 | 功能 |
|------|------|------|
| GET | `/api/evaluations/:id/entities` | 获取待评价供应商列表 |
| PUT | `/api/evaluations/:id/entities/:entityName` | 保存供应商评价 |

### 结果查询

| 方法 | 路径 | 功能 |
|------|------|------|
| GET | `/api/evaluations/:id/results` | 获取评价结果 |
| GET | `/api/evaluations/trend/:entityName` | 获取供应商趋势数据 |
| GET | `/api/evaluations/accumulated/:year` | 获取年度累计数据 |

### 配置管理

| 方法 | 路径 | 功能 |
|------|------|------|
| GET | `/api/evaluation-config` | 获取评价配置 |
| PUT | `/api/evaluation-config` | 更新评价配置 |
| POST | `/api/evaluation-config/reset` | 重置为默认配置 |

---

## 数据流程

### 流程一：创建并完成一次评价

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│  选择周期类型    │ ──→ │  设置日期范围    │ ──→ │  创建评价周期   │
└─────────────────┘     └──────────────────┘     └─────────────────┘
                                                        │
                                                        ▼
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│  统计等级分布    │ ←── │  渲染热力图      │ ←── │  提交评价       │
└─────────────────┘     └──────────────────┘     └─────────────────┘
                                                        │
                                                        ▼
                                               ┌─────────────────┐
                                               │  提取IQC数据    │
                                               │  生成供应商列表  │
                                               └─────────────────┘
```

### 流程二：评分计算

```
输入分数 ──→ 乘以权重 ──→ 求和 ──→ 对照等级规则 ──→ 确定等级
{
  quality: 90,
  delivery: 85,
  service: 88
}           │
            ▼
     90×0.5 + 85×0.3 + 88×0.2 = 88.1
                                    │
                                    ▼
                            88.1 落在 85-94.99
                                    │
                                    ▼
                              等级: "合格"
```

---

## 关键技术点

### 1. 配置快照机制

每次创建评价周期时，系统会保存当前的评价配置快照：

```javascript
const configSnapshot = {
    dimensions: [
        { name: "质量", key: "quality", weight: 0.5 },
        { name: "交付", key: "delivery", weight: 0.3 },
        { name: "服务", key: "service", weight: 0.2 }
    ],
    gradeRules: [
        { min: 95, max: 100, label: "优秀" },
        { min: 85, max: 94.99, label: "合格" },
        // ...
    ]
};
```

**优点**：
- 历史评价数据不受后续配置变更影响
- 可以追溯某次评价使用的是哪个版本的配置

### 2. 数据类型分离

系统通过 `data_type` 字段区分外购和外协数据：

- `purchase`：外购物料供应商
- `external`：外协加工供应商

这使得两种类型的供应商可以独立评价、独立统计。

### 3. IQC数据联动

系统自动从IQCData表提取评价周期内的质量数据：

```javascript
// 查询与评价周期有交集的IQC数据
where: {
    timeRangeStart: { [Op.lte]: endDate },
    timeRangeEnd: { [Op.gte]: startDate }
}
```

提取的数据包括：
- totalBatches：总批次
- okBatches：合格批次
- ngBatches：不合格批次
- passRate：合格率

### 4. 年度累计计算

仪表盘的年度累计数据通过 `getAccumulatedResults` 服务方法获取：

- 查询该年份所有已完成的状态为 `completed` 的评价
- 按供应商维度去重统计
- 汇总各等级数量
- 计算平均分数

---

## 页面结构

### 主界面（仪表盘）

```
┌─────────────────────────────────────────────────────────┐
│  [外购] [外协]  │  2025年 ▼  │   ← 类型/年份选择器    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │
│  │ 优秀 X个  │ │ 合格 X个  │ │整改X个   │ │不合格X个 │  │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘  │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │              年度排名热力图                        │   │
│  │  供应商 │ 1月 │ 2月 │ 3月 │ ... │ 12月 │       │   │
│  │  供应商A │ 优秀│ 合格│ ... │     │      │       │   │
│  │  供应商B │ 合格│ ... │     │     │      │       │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │              趋势图表                             │   │
│  │  平均分趋势 │ 等级分布趋势                        │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 评价执行界面

```
┌─────────────────────────────────────────────────────────┐
│  ← 返回    2025年1月评价                    外购 ▼     │
├─────────────────────────────────────────────────────────┤
│  已评价: 8/12  │  待评价: 4                            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ 供应商A    │  │ 供应商B    │  │ 供应商C    │     │
│  │ 得分: 88   │  │ 得分: 92   │  │ 待评价     │     │
│  │ 等级: 合格  │  │ 等级: 优秀  │  │            │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
│                                                         │
└─────────────────────────────────────────────────────────┘

点击"待评价"卡片 → 弹出评分弹窗：
┌─────────────────────────────────────────────────────────┐
│  供应商名称: 供应商C                                     │
│                                                         │
│  质量数据（本期）：总批次 50，合格 48，合格率 96%        │
│                                                         │
│  质量评分: [________]                                   │
│  交付评分: [________]                                   │
│  服务评分: [________]                                   │
│                                                         │
│  备注: [________________________________]              │
│                                                         │
│            [取消]  [保存]                               │
└─────────────────────────────────────────────────────────┘
```

---

## 扩展与优化

### 当前限制

1. **年度累计数据混合计算**：当同时存在月度评价和季度评价时，累计数据会混合计算，可能导致数据重复统计
2. **缺少批量评价**：只能逐个评价供应商
3. **不支持导出**：无法导出Excel/PDF格式的评价报告

### 未来扩展方向

1. **增加周期类型筛选**：在仪表盘增加"月度/季度"筛选器
2. **批量评价功能**：支持批量导入分数
3. **报告导出**：支持导出详细的评价报告
4. **邮件通知**：评价完成后自动发送通知
5. **历史对比**：支持对比不同周期的评价结果

---

## 常见问题

### Q: 评价配置修改后会影响历史评价吗？
A: 不会。每次创建评价周期时会保存配置快照，历史评价使用的是创建时的配置。

### Q: 如何区分外购和外协供应商？
A: 通过VendorConfig表的data_type字段区分，评价详情中也会记录data_type。

### Q: 如果某个供应商在评价周期内没有IQC数据怎么办？
A: 系统仍会创建该供应商的评价记录，但质量数据快照为空，评分时需要手动填写。

### Q: 可以同时进行多个评价周期吗？
A: 可以，每个评价周期独立运作，互不影响。

---

## 数据库表关系

```
┌────────────────────────────────────┐
│  performance_evaluations           │  ← 评价周期表
│  (id, period_name, period_type,   │
│   start_date, end_date, status,   │
│   config_snapshot)                │
└───────────────┬────────────────────┘
                │ 1:N
                ▼
┌────────────────────────────────────┐
│  performance_evaluation_details     │  ← 评价详情表
│  (id, evaluation_id,               │
│   evaluation_entity_name,          │
│   data_type, scores,               │
│   total_score, grade,              │
│   quality_data_snapshot)           │
└────────────────────────────────────┘
                ▲
                │ 关联查询
┌───────────────┴────────────────────┐
│  vendor_configs                    │  ← 供应商配置表
│  (supplier_name, data_type,       │
│   enable_performance_mgmt)         │
└────────────────────────────────────┘
```
