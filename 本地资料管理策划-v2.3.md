# 本地资料管理架构设计

**来源**: 供应商资料管理系统产品策划 v2.3 (gemini v0.1)  
**策划日期**: 2025-12-02  
**核心功能**: 系统与本地文件夹自动同步，实现真正的本地资料管理

---

## 🎯 一、核心理念

> "当在系统中删除、新增资料时，本地的某个区域也会对pdf等文件进行调整，以便于真的做到本地资料管理"

系统中的所有文件操作（上传、删除、更新）都会自动同步到本地文件夹，确保本地文件结构与系统数据完全一致。

---

## 🗂️ 二、文件夹结构规范

### 2.1 标准目录结构（基于v3.1新架构）

根据供应商资料管理v3.1的新架构，采用**两层结构**：通用资料和物料资料

```
uploads/
├── {供应商名称}/
│   ├── 通用资料/
│   │   ├── {证书类型}/
│   │   │   ├── 文件1.pdf
│   │   │   ├── 文件2.pdf
│   │   │   └── ...
│   │   └── ...
│   └── 物料资料/
│       ├── {物料名称}/
│       │   ├── {证书类型}/
│       │   │   ├── 文件1.pdf
│       │   │   ├── 文件2.pdf
│       │   │   └── ...
│       │   └── ...
│       └── ...
└── ...
```

### 2.2 实际示例结构（基于v3.1实际数据）

```
uploads/
├── 供应商A/
│   ├── 通用资料/
│   │   ├── 质量协议/
│   │   │   ├── 供应商A_质量协议_v1_20250115.pdf
│   │   │   └── 供应商A_质量协议_v2_20251201.pdf
│   │   └── MSDS/
│   │       └── 供应商A_MSDS_v1_20250630.pdf
│   └── 物料资料/
│       ├── 胶带/
│       │   ├── ROHS/
│       │   │   ├── 供应商A_胶带_ROHS_成分A_v1_20251101.pdf
│       │   │   └── 供应商A_胶带_ROHS_成分A_v2_20251201.pdf
│       │   ├── REACH/
│       │   │   └── 供应商A_胶带_REACH_成分A_v1_20250615.pdf
│       │   ├── HF/
│       │   │   └── 供应商A_胶带_HF_成分A_v1_20250910.pdf
│       │   └── MSDS/
│       │       └── 供应商A_胶带_MSDS_成分A_v1_20250320.pdf
│       └── PIN脚/
│           ├── ROHS/
│           │   └── 供应商A_PIN脚_ROHS_成分B_v1_20250820.pdf
│           └── REACH/
│               └── 供应商A_PIN脚_REACH_成分B_v1_20251130.pdf
├── 供应商B/
│   ├── 通用资料/
│   │   └── 质量协议/
│   │       └── 供应商B_质量协议_v1_20250228.pdf
│   └── 物料资料/
│       └── 电木粉/
│           ├── ROHS/
│           │   └── 供应商B_电木粉_ROHS_成分C_v1_20251015.pdf
│           └── HF/
│               └── 供应商B_电木粉_HF_成分C_v1_20250725.pdf
└── ...
```

### 2.3 v3.1架构说明

**两层结构设计**：
- **通用资料层**: 通用资料（质量协议、MSDS等）
- **物料资料层**: 物料级资料（ROHS、REACH、HF等），按物料分组

**与v3.1数据结构对应**：
- 通用资料对应 `supplier_documents` 表中 `level='supplier'` 的记录
- 物料资料对应 `supplier_documents` 表中 `level='component'` 的记录
- 构成信息作为文件名的一部分，体现为备注信息

**优势**：
1. ✅ 与系统界面结构完全一致
2. ✅ 便于用户理解和查找
3. ✅ 支持通用资料和物料资料的独立管理
4. ✅ 构成信息清晰可见

---

## 🔄 三、文件同步机制

### 3.1 上传同步
- **触发时机**: 用户在系统中上传文件时
- **同步动作**: 
  - 自动创建对应的文件夹结构（供应商→通用资料/物料资料→证书类型）
  - 将文件保存到对应目录
  - 按v3.1命名规范重命名文件
  - 更新数据库记录
- **增强功能**:
  - 上传前磁盘空间检查
  - 并发操作控制，避免同时操作同一文件
  - 临时文件自动清理机制

### 3.2 供应商同步
- **触发时机**: 用户点击"同步供应商"按钮时
- **同步动作**:
  - 从IQC系统获取供应商列表
  - 为每个新供应商自动创建本地文件夹结构
  - 创建通用资料和物料资料的基础目录
  - 记录同步日志和状态
- **文件夹结构**:
  ```
  uploads/
  ├── 供应商A/
  │   ├── 通用资料/
  │   └── 物料资料/
  ├── 供应商B/
  │   ├── 通用资料/
  │   └── 物料资料/
  └── ...
  ```

### 3.3 删除同步
- **触发时机**: 用户在系统中删除文件记录时
- **同步动作**:
  - 从数据库中删除文件记录
  - 将本地文件移动到备份文件夹，而非直接删除
  - 记录删除日志和备份位置
  - 如果原文件夹为空，可选择是否删除空文件夹
- **完整文件夹结构**:
  ```
  uploads/
  ├── _backup/                                    # 🔒 备份区域：存放所有删除的文件
  │   ├── 2025-12-03/
  │   │   ├── 供应商A_质量协议_v1_20250115.pdf      # 从 供应商A/通用资料/质量协议/ 备份
  │   │   ├── 供应商A_胶带_ROHS_成分A_v1_20251101.pdf # 从 供应商A/物料资料/胶带/ROHS/ 备份
  │   │   ├── 供应商B_PIN脚_REACH_成分B_v1_20250820.pdf # 从 供应商B/物料资料/PIN脚/REACH/ 备份
  │   │   └── backup_log_2025-12-03.txt             # 备份操作日志
  │   └── 2025-12-04/
  │       ├── 供应商C_电木粉_HF_成分C_v1_20250725.pdf  # 从 供应商C/物料资料/电木粉/HF/ 备份
  │       └── backup_log_2025-12-04.txt               # 备份操作日志
  │
  ├── 供应商A/                                      # 📁 正常业务区域：当前有效的文件
  │   ├── 通用资料/
  │   │   └── 质量协议/
  │   │       └── 供应商A_质量协议_v2_20251201.pdf   # 当前有效版本
  │   └── 物料资料/
  │       └── 胶带/
  │           └── ROHS/
  │               └── 供应商A_胶带_ROHS_成分A_v2_20251201.pdf # 当前有效版本
  │
  ├── 供应商B/                                      # 📁 正常业务区域
  │   ├── 通用资料/
  │   │   └── 质量协议/
  │   │       └── 供应商B_质量协议_v1_20250228.pdf   # 当前有效版本
  │   └── 物料资料/
  │       └── PIN脚/
  │           └── REACH/
  │               └── 供应商B_PIN脚_REACH_成分B_v1_20251130.pdf # 当前有效版本
  │
  └── 供应商C/                                      # 📁 正常业务区域
      ├── 通用资料/
      └── 物料资料/
          └── 电木粉/
              └── HF/
                  └── 供应商C_电木粉_HF_成分C_v1_20250725.pdf # 当前有效版本
  ```

**结构说明**：
- 🔒 **备份区域** (`_backup/`): 存放所有被删除的文件，按日期分组
- 📁 **正常业务区域** (`供应商A/`, `供应商B/` 等): 存放当前有效的文件
- 🔄 **文件流转**: 正常业务区域 → 备份区域（当用户删除文件时）
- 📝 **日志记录**: 每个备份操作都会在对应的日志文件中记录原始路径
- **增强功能**:
  - 删除确认对话框，显示将被删除的文件信息
  - 删除失败时的错误恢复机制
  - 批量删除支持，提高操作效率
  - 备份文件自动按日期分组管理
  - 备份文件定期清理机制（可选）

### 3.4 更新同步

**当前状况**：
- 系统目前没有设计更新按钮
- 采用删除+新增的方式处理文件更新
- 需要讨论是否要增加更新功能

**方案A：保持现状（删除+新增）**
- **优势**: 简单直接，与现有UI一致
- **劣势**: 无法保留版本历史，用户体验不够直观
- **实现**: 删除时移动到备份，新增时按新版本处理

**方案B：增加更新功能**
- **优势**: 保留版本历史，操作更直观
- **劣势**: 需要修改UI，增加开发复杂度
- **实现**: 
  - 在文件操作中增加"更新"按钮
  - 点击更新时上传新文件，自动递增版本号
  - 旧版本移动到备份文件夹

**最终决定**：
经过讨论，决定采用**方案A**（删除+新增），原因：
1. 保持现有UI的简洁性，用户学习成本低
2. 通过备份机制保证文件安全，不会真正丢失
3. 符合资料管理的实际使用场景
4. 开发成本更低，实现更简单

**实现方式**：
- 删除文件时自动移动到备份文件夹
- 新增文件时按新版本处理
- 通过备份日志可以追溯文件历史

### 3.5 结构同步
- **触发时机**: 物料结构调整时（新增/删除/重命名物料或构成）
- **同步动作**:
  - 自动调整本地文件夹结构
  - 移动相关文件到新的对应位置
  - 更新文件路径记录
  - 保持数据一致性

#### 3.5.1 新增物料/构成
- **同步动作**:
  - 在对应供应商的物料资料目录下创建新文件夹
  - 创建对应的证书类型子文件夹
  - 记录新增操作日志

#### 3.5.2 删除物料/构成 ⚠️ **重要**
- **同步动作**:
  - **批量备份**: 将该物料/构成下的所有文件移动到备份文件夹
  - 删除对应的文件夹结构
  - 更新数据库中所有相关记录
  - 记录批量删除操作日志
- **备份示例**:
  ```
  删除物料"胶带"时：
  ├── 供应商A/物料资料/胶带/ROHS/供应商A_胶带_ROHS_成分A_v1.pdf → 备份到 _backup/2025-12-03/
  ├── 供应商A/物料资料/胶带/REACH/供应商A_胶带_REACH_成分A_v1.pdf → 备份到 _backup/2025-12-03/
  ├── 供应商A/物料资料/胶带/HF/供应商A_胶带_HF_成分A_v1.pdf → 备份到 _backup/2025-12-03/
  └── 日志记录: "批量备份: 物料'胶带'下的3个文件"
  ```

#### 3.5.3 重命名物料/构成
- **同步动作**:
  - 重命名本地文件夹
  - 更新所有相关文件的路径记录
  - 记录重命名操作日志

- **增强功能**:
  - 同步失败时的回滚机制
  - 文件移动日志记录
  - 批量操作的进度显示

### 3.6 事务性和一致性保证
- **事务处理**: 文件操作和数据库操作在同一事务中
- **错误回滚**: 操作失败时自动回滚文件和数据库更改
- **实时同步**: 每个操作都确保文件系统与数据库的实时一致性
- **日志追踪**: 通过详细的操作日志确保所有变更可追溯

**关于状态检查和自动修复的考虑**：
考虑到前面的同步机制（上传、删除、供应商同步、结构同步）都已经确保了操作的原子性和一致性，传统的定期状态检查和自动修复机制可能是不必要的。原因：

1. **操作级一致性**: 每个文件操作都保证了一致性
2. **实时同步**: 不存在延迟同步导致的不一致
3. **复杂性增加**: 自动修复可能引入新的风险
4. **维护成本**: 额外的检查机制增加系统复杂度

**替代方案**：
- 提供手动一致性检查工具（可选）
- 通过日志文件进行问题排查
- 在关键操作前进行预检查

---

## 📝 四、文件命名规范

### 4.1 标准命名格式（基于v3.1新架构）

**通用资料命名格式**：
```
{供应商名称}_{证书类型}_v{版本号}_{日期}.{扩展名}
```

**物料资料命名格式**：
```
{供应商名称}_{物料名称}_{证书类型}_{构成名称}_v{版本号}_{日期}.{扩展名}
```

### 4.2 命名示例

**通用资料示例**：
- `供应商A_质量协议_v1_20250115.pdf`
- `供应商A_MSDS_v1_20250630.pdf`
- `供应商B_质量协议_v1_20250228.pdf`

**物料资料示例**：
- `供应商A_胶带_ROHS_成分A_v1_20251101.pdf`
- `供应商A_胶带_ROHS_成分A_v2_20251201.pdf`
- `供应商A_PIN脚_REACH_成分B_v1_20250820.pdf`
- `供应商B_电木粉_HF_成分C_v1_20250725.pdf`

### 4.3 版本控制规则
- **版本号格式**: v{数字} (如: v1, v2, v3)
- **自动递增**: 新版本自动递增版本号
- **历史归档**: 历史文件保留在原目录或专门的archive文件夹
- **当前版本**: 最新版本作为主要文件，数据库指向当前版本

---

## 🏗️ 五、技术实现架构

### 5.1 文件操作服务层
```javascript
class LocalFileSyncService {
  // 上传文件同步
  async syncUpload(fileData, supplierInfo, materialInfo, documentType) {
    // 1. 创建文件夹结构（基于v3.1架构）
    await this.createFolderStructureV31(supplierInfo, materialInfo, documentType, componentInfo);
    
    // 2. 生成标准文件名（基于v3.1命名规范）
    const fileName = this.generateFileNameV31(fileData, supplierInfo, materialInfo, documentType, componentInfo);
    
    // 3. 保存文件到本地
    await this.saveFileToLocal(fileData, fileName);
    
    // 4. 更新数据库记录
    await this.updateDatabaseRecord(fileData, fileName);
  }
  
  // 删除文件同步
  async syncDelete(documentId) {
    // 1. 获取文件信息
    const fileInfo = await this.getDocumentInfo(documentId);
    
    // 2. 移动文件到备份文件夹
    await this.moveToBackupFolder(fileInfo);
    
    // 3. 删除数据库记录
    await this.deleteDatabaseRecord(documentId);
    
    // 4. 清理空文件夹
    await this.cleanEmptyFolders(fileInfo.folderPath);
  }
  
  // 移动文件到备份文件夹
  async moveToBackupFolder(fileInfo) {
    const backupPath = this.generateBackupPath(fileInfo);
    await fs.ensureDir(path.dirname(backupPath));
    await fs.move(fileInfo.filePath, backupPath);
    
    // 记录中文备份日志
    await this.logBackupOperation(fileInfo, backupPath);
  }
  
  // 生成统一备份路径
  generateBackupPath(fileInfo) {
    const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
    const backupDir = path.join('uploads', '_backup', today);
    const fileName = path.basename(fileInfo.filePath);
    return path.join(backupDir, fileName);
  }
  
  // 记录中文备份日志
  async logBackupOperation(fileInfo, backupPath) {
    const today = new Date().toISOString().split('T')[0];
    const logFile = path.join('uploads', '_backup', today, `backup_log_${today}.txt`);
    const timestamp = new Date().toLocaleString('zh-CN');
    
    const logEntry = `[${timestamp}] 文件备份: "${path.basename(fileInfo.filePath)}" 从 "${fileInfo.originalPath}" 移动到 "${backupPath}"\n`;
    
    await fs.appendFile(logFile, logEntry, 'utf8');
  }
  
  // 批量备份物料下的所有文件
  async backupMaterialFiles(materialId, materialName) {
    const today = new Date().toISOString().split('T')[0];
    const backupDir = path.join('uploads', '_backup', today);
    await fs.ensureDir(backupDir);
    
    const logFile = path.join(backupDir, `backup_log_${today}.txt`);
    const timestamp = new Date().toLocaleString('zh-CN');
    
    // 获取物料下的所有文件
    const materialFiles = await this.getMaterialFiles(materialId);
    
    for (const file of materialFiles) {
      const backupPath = path.join(backupDir, path.basename(file.filePath));
      await fs.move(file.filePath, backupPath);
      
      const logEntry = `[${timestamp}] 批量备份: "${path.basename(file.filePath)}" 从 "${file.originalPath}" 移动到 "${backupPath}" (物料: ${materialName})\n`;
      await fs.appendFile(logFile, logEntry, 'utf8');
    }
  }
  
  // 更新文件同步
  async syncUpdate(documentId, newFileData) {
    // 1. 获取当前文件信息
    const currentInfo = await this.getDocumentInfo(documentId);
    
    // 2. 归档历史版本
    await this.archivePreviousVersion(currentInfo);
    
    // 3. 保存新版本
    await this.saveNewVersion(documentId, newFileData);
    
    // 4. 更新数据库
    await this.updateVersionInfo(documentId, newFileData);
  }
}
```

### 5.2 文件夹管理工具
```javascript
class FolderManager {
  // 创建文件夹结构（基于v3.1架构）
  async createFolderStructureV31(supplierName, materialName, documentType, componentName) {
    const basePath = 'uploads/';
    const supplierPath = path.join(basePath, supplierName);
    
    // 根据资料类型确定路径
    if (this.isCommonDocument(documentType)) {
      // 通用资料路径：uploads/供应商A/通用资料/质量协议/
      const commonPath = path.join(supplierPath, '通用资料');
      const documentPath = path.join(commonPath, documentType);
      
      await fs.ensureDir(documentPath);
      
      return {
        supplierPath,
        commonPath,
        documentPath
      };
    } else {
      // 物料资料路径：uploads/供应商A/物料资料/胶带/ROHS/
      const materialPath = path.join(supplierPath, '物料资料', materialName);
      const documentPath = path.join(materialPath, documentType);
      
      await fs.ensureDir(documentPath);
      
      return {
        supplierPath,
        materialPath,
        documentPath
      };
    }
  }
  
  // 判断是否为通用资料
  isCommonDocument(documentType) {
    const commonTypes = ['质量协议', 'MSDS', '企业资质', 'ISO认证'];
    return commonTypes.includes(documentType);
  }
  
  // 为供应商创建基础文件夹结构
  async createSupplierFolderStructure(supplierName) {
    const basePath = 'uploads/';
    const supplierPath = path.join(basePath, supplierName);
    const commonPath = path.join(supplierPath, '通用资料');
    const materialPath = path.join(supplierPath, '物料资料');
    
    // 创建基础文件夹结构
    await fs.ensureDir(commonPath);
    await fs.ensureDir(materialPath);
    
    return {
      supplierPath,
      commonPath,
      materialPath
    };
  }
  
  // 清理空文件夹
  async cleanEmptyFolders(folderPath) {
    const isEmpty = await this.isFolderEmpty(folderPath);
    if (isEmpty) {
      await fs.remove(folderPath);
      // 递归清理上级空文件夹
      const parentPath = path.dirname(folderPath);
      if (parentPath !== 'uploads/') {
        await this.cleanEmptyFolders(parentPath);
      }
    }
  }
  
  // 移动文件夹（结构调整时）
  async moveFolderStructure(oldPath, newPath) {
    await fs.move(oldPath, newPath);
    // 更新数据库中所有相关文件的路径
    await this.updateFilePathsInDatabase(oldPath, newPath);
  }
}
```

---

## 🔧 六、技术实现要点

### 6.1 数据一致性保证
- **事务处理**: 文件操作和数据库操作在同一事务中
- **错误回滚**: 操作失败时自动回滚文件和数据库更改
- **状态检查**: 定期检查本地文件与数据库记录的一致性
- **自动修复**: 发现不一致时的自动修复机制

### 6.2 性能优化
- **异步操作**: 文件操作使用异步处理，避免阻塞
- **批量处理**: 支持批量文件操作，提高效率
- **缓存机制**: 文件路径信息缓存，减少磁盘访问
- **并发控制**: 避免同时操作同一文件造成的冲突

### 6.3 错误处理与健壮性
- **磁盘空间检查**: 上传前检查可用磁盘空间
- **权限检查**: 确保有文件读写权限
- **文件大小限制**: 根据文件类型设置不同的大小限制
- **网络异常**: 网络异常时的重试机制
- **日志记录**: 详细记录所有文件操作日志和错误信息

### 6.4 文件操作安全
- **文件类型验证**: 严格的文件类型白名单验证
- **文件名安全**: 防止路径遍历和文件名注入攻击
- **临时文件管理**: 安全的临时文件创建和清理
- **病毒扫描**: 可选的文件上传病毒扫描功能

---

## 📊 七、监控与维护

### 7.1 同步状态监控
- **实时监控**: 监控文件同步状态
- **异常报警**: 同步失败时发送报警
- **统计报告**: 定期生成同步统计报告

### 7.2 数据修复工具
- **一致性检查**: 检查本地文件与数据库的一致性
- **自动修复**: 发现不一致时的自动修复机制
- **手动修复**: 提供手动修复工具

### 7.3 备份策略
- **定期备份**: 定期备份整个uploads目录
- **增量备份**: 支持增量备份机制
- **恢复机制**: 快速恢复机制

---

## 🎯 八、用户体验与实用功能

### 8.1 文件管理实用功能
- **文件快速预览**: 在系统中直接预览PDF、图片等文件内容
- **文件快速打开**: 一键打开本地文件所在文件夹
- **文件搜索功能**: 支持在文件名和内容中搜索特定文件
- **批量文件操作**: 支持批量下载、移动、删除等操作
- **文件使用统计**: 记录文件访问频率，便于管理

### 8.2 操作透明性
- **状态反馈**: 实时反馈操作状态和结果
- **错误提示**: 友好的错误提示信息和解决建议
- **操作日志**: 详细记录所有文件操作日志

### 8.3 界面交互优化
- **文件状态图标化**: 用直观图标显示文件状态（正常/即将到期/已过期）
- **拖拽上传优化**: 支持拖拽文件到具体物料位置上传
- **快捷操作菜单**: 右键菜单支持常用操作（预览、打开、删除、编辑）
- **文件历史时间线**: 展示文件更新历史和版本变化
- **批量选择优化**: 更好的批量操作体验和视觉反馈

### 8.4 便捷性功能
- **快速访问**: 可直接从系统快速访问本地文件
- **智能路径**: 自动记录常用文件路径，便于快速访问
- **文件关联**: 显示相关文件和关联资料
- **快捷键支持**: 支持常用操作的快捷键

---

## 📋 九、实施计划

### 9.1 第一阶段：基础架构（核心同步功能）
- [ ] 实现LocalFileSyncService基础服务
- [ ] 实现FolderManager文件夹管理（基于v3.1架构）
- [ ] 建立文件命名规范（通用资料/物料资料分类）
- [ ] 实现基础的同步机制（上传/删除/更新/结构同步）
- [ ] 实现事务性和一致性保证机制

### 9.2 第二阶段：增强功能（实用功能）
- [ ] 实现文件快速预览和打开功能
- [ ] 实现文件搜索和批量操作
- [ ] 实现拖拽上传优化
- [ ] 实现文件状态图标化显示
- [ ] 实现快捷操作菜单和右键功能

### 9.3 第三阶段：健壮性提升（稳定性）
- [ ] 实现错误处理和回滚机制
- [ ] 实现性能优化和并发控制
- [ ] 实现文件操作安全机制
- [ ] 实现监控和自动修复
- [ ] 实现备份和恢复机制

### 9.4 第四阶段：用户体验优化
- [ ] 实现状态反馈优化
- [ ] 实现文件历史时间线
- [ ] 实现批量选择优化
- [ ] 实现操作日志和统计
- [ ] 完善用户交互细节

---

## 🎉 十、预期效果与价值

### 10.1 核心功能效果
- ✅ 系统与本地文件完全同步，实时一致
- ✅ 文件夹结构清晰规范，符合v3.1架构
- ✅ 支持版本管理和历史追溯，便于审计
- ✅ 自动化程度高，大幅减少人工操作

### 10.2 用户体验提升
- ✅ 文件预览和打开便捷，提升日常效率
- ✅ 操作反馈及时准确，状态一目了然
- ✅ 错误处理友好，问题快速定位
- ✅ 性能稳定可靠，支持大文件操作

### 10.3 管理效益提升
- ✅ 数据一致性保证，避免系统与文件不一致
- ✅ 维护成本降低，自动化程度高
- ✅ 工作效率提升，批量操作支持
- ✅ 风险控制加强，事务性和回滚机制

### 10.4 相比Excel的优势体现
- ✅ **状态可视化**: 自动颜色标识 vs 手动条件格式
- ✅ **到期提醒**: 自动预警 vs 手动检查
- ✅ **快速查找**: 多维度筛选 vs Ctrl+F搜索
- ✅ **版本管理**: 自动版本控制 vs 手动备份
- ✅ **批量操作**: 一键批量 vs 复制粘贴
- ✅ **移动办公**: 随时访问 vs 固定电脑

---

**总结**: 通过本地资料管理架构设计，实现了系统与本地文件的完美同步，用户在系统中的所有操作都会自动反映到本地文件系统，真正做到了"本地资料管理"的目标。这不仅提高了数据可靠性，也为用户提供了更加灵活和便捷的文件管理方式。