# 供应商配置管理中心实施计划

## 📋 目录
1. [需求分析](#需求分析)
2. [架构设计](#架构设计)
3. [数据库设计](#数据库设计)
4. [API设计](#api设计)
5. [前端设计](#前端设计)
6. [实施步骤](#实施步骤)
7. [测试计划](#测试计划)
8. [风险控制](#风险控制)

---

## 需求分析

### 当前问题
1. 供应商资料管理模块被动接收所有IQC供应商，无法选择性地管理
2. 缺少统一的供应商配置管理中心
3. 供应商资料管理和绩效评价模块没有可控的数据源

### 核心需求
1. 创建供应商配置管理中心作为数据分发中枢
2. 通过勾选配置决定哪些供应商显示在资料管理和绩效评价模块
3. 供应商资料管理不再获取IQC数据，只从配置中心获取供应商列表
4. 绩效评价从配置中心获取供应商列表，再关联IQC质量数据

### 非功能需求
- 命名规范：避开supplier关键字，使用vendor-前缀
- CSS规范：遵循BEM命名规范，使用CSS变量，禁止硬编码
- 性能要求：响应时间<500ms
- 可维护性：代码模块化，单一职责

---

## 架构设计

### 整体架构
```
┌─────────────────────────────────────────────────────────────┐
│                    IQC Excel上传                             │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
              ┌─────────────────────┐
              │   IQCData表         │
              │   (rawData包含      │
              │    供应商名称)      │
              └──────────┬──────────┘
                         │
                         ▼
         ┌───────────────────────────────┐
         │  自动同步/手动同步             │
         │  (混合模式)                   │
         └───────────────┬───────────────┘
                         │
                         ▼
         ┌───────────────────────────────┐
         │  VendorConfig表（配置中心）    │
         │  ┌─────────────────────────┐  │
         │  │ supplier_name           │  │
         │  │ source                  │  │
         │  │ enable_document_mgmt    │  │
         │  │ enable_performance_mgmt │  │
         │  │ status                  │  │
         │  └─────────────────────────┘  │
         └───────┬───────────┬───────────┘
                 │           │
        ┌────────┘           └────────┐
        ▼                             ▼
┌───────────────────┐       ┌───────────────────┐
│ 供应商资料管理    │       │  绩效评价模块     │
│ ┌───────────────┐ │       │ ┌───────────────┐ │
│ │ 查询条件：    │ │       │ │ 查询条件：    │ │
│ │ enable_       │ │       │ │ enable_       │ │
│ │ document_     │ │       │ │ performance_  │ │
│ │ mgmt = 1      │ │       │ │ mgmt = 1      │ │
│ └───────────────┘ │       │ └───────────────┘ │
│                   │       │                   │
│ 只从VendorConfig  │       │ 从VendorConfig    │
│ 获取供应商列表    │       │ 获取供应商列表    │
│                   │       │                   │
│ 不获取IQC数据     │       │ 关联IQC质量数据    │
└───────────────────┘       └───────────────────┘
```

### 技术架构
- **后端**：Node.js + Express + Sequelize
- **前端**：原生JavaScript + BEM CSS
- **数据库**：SQLite
- **架构模式**：三层架构（表现层-业务层-数据层）

---

## 数据库设计

### VendorConfig表
```sql
CREATE TABLE vendor_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    supplier_name VARCHAR(255) NOT NULL UNIQUE,
    source VARCHAR(50) DEFAULT 'IQC',
    enable_document_mgmt BOOLEAN DEFAULT 0,
    enable_performance_mgmt BOOLEAN DEFAULT 0,
    status VARCHAR(20) DEFAULT 'Active',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_vendor_config_supplier_name ON vendor_config(supplier_name);
CREATE INDEX idx_vendor_config_source ON vendor_config(source);
CREATE INDEX idx_vendor_config_status ON vendor_config(status);
CREATE INDEX idx_vendor_config_enable_document ON vendor_config(enable_document_mgmt);
CREATE INDEX idx_vendor_config_enable_performance ON vendor_config(enable_performance_mgmt);
```

### Supplier表（保留不变）
- 用于存储供应商的联系人、地址等基础信息
- 不再作为供应商列表的数据源

### 数据关系
- VendorConfig.supplier_name → Supplier.name（通过名称关联）
- VendorConfig.supplier_name → IQCData.rawData（通过名称关联）

---

## API设计

### 配置中心API（/api/vendors/*）

#### 1. 获取配置列表
```
GET /api/vendors/config
Query: ?source=IQC&status=Active
Response: {
  success: true,
  data: [
    {
      id: 1,
      supplier_name: "供应商A",
      source: "IQC",
      enable_document_mgmt: true,
      enable_performance_mgmt: false,
      status: "Active",
      created_at: "2025-01-01T00:00:00.000Z",
      updated_at: "2025-01-01T00:00:00.000Z"
    }
  ]
}
```

#### 2. 更新配置
```
PUT /api/vendors/config/:id
Body: {
  enable_document_mgmt: true,
  enable_performance_mgmt: false,
  status: "Active"
}
Response: {
  success: true,
  message: "配置更新成功"
}
```

#### 3. 从IQC同步供应商
```
POST /api/vendors/sync-from-iqc
Body: {
  mode: "full" | "incremental"
}
Response: {
  success: true,
  message: "同步完成：新增 5 个，更新 3 个，跳过 2 个",
  stats: {
    created: 5,
    updated: 3,
    skipped: 2
  }
}
```

#### 4. 手动添加供应商
```
POST /api/vendors/config
Body: {
  supplier_name: "供应商X",
  source: "MANUAL",
  enable_document_mgmt: false,
  enable_performance_mgmt: false
}
Response: {
  success: true,
  message: "供应商添加成功",
  data: { id: 10 }
}
```

#### 5. 删除供应商配置
```
DELETE /api/vendors/config/:id
Response: {
  success: true,
  message: "供应商删除成功"
}
```

#### 6. 获取已启用的供应商（资料管理）
```
GET /api/vendors/active/document
Response: {
  success: true,
  data: [
    { id: 1, supplier_name: "供应商A" },
    { id: 2, supplier_name: "供应商B" }
  ]
}
```

#### 7. 获取已启用的供应商（绩效评价）
```
GET /api/vendors/active/performance
Response: {
  success: true,
  data: [
    { id: 1, supplier_name: "供应商A" },
    { id: 3, supplier_name: "供应商C" }
  ]
}
```

### 修改后的供应商资料管理API

#### 修改GET /api/suppliers/documents-summary
```javascript
// 修改前：从suppliers表获取供应商
// 修改后：从vendor_config表获取供应商
const [suppliers] = await sequelize.query(`
  SELECT vc.id, vc.supplier_name as name
  FROM vendor_config vc
  WHERE vc.enable_document_mgmt = 1
    AND vc.status = 'Active'
  ORDER BY vc.supplier_name ASC
`);
```

---

## 前端设计

### 命名规范

#### JavaScript命名
```javascript
// 模块级服务对象
window.vendorConfigServices

// 模块级工具对象
window.vendorConfigUIUtils

// 主管理器
window.vendorConfigManager
```

#### CSS命名（BEM规范）
```css
/* 配置中心模块 - 使用vendor-前缀 */
.vendor-config__container
.vendor-config__header
.vendor-config__table
.vendor-config__row
.vendor-config__cell
.vendor-config__cell--name
.vendor-config__cell--source
.vendor-config__cell--status
.vendor-config__checkbox
.vendor-config__checkbox--checked
.vendor-config__btn
.vendor-config__btn--primary
.vendor-config__modal
.vendor-config__modal__header
.vendor-config__modal__body
.vendor-config__modal__footer
```

#### CSS变量
```css
:root {
  --vendor-color-primary: #2563eb;
  --vendor-color-success: #10b981;
  --vendor-color-warning: #f59e0b;
  --vendor-color-danger: #ef4444;
  --vendor-spacing-sm: 8px;
  --vendor-spacing-md: 16px;
  --vendor-spacing-lg: 24px;
  --vendor-border-radius: 8px;
}
```

### 界面设计

#### 配置中心页面结构
```html
<div id="module-vendor-config" class="module-view hidden">
  <div class="module-header">
    <h3>供应商配置中心</h3>
    <div class="module-actions">
      <button class="btn btn-primary" id="syncFromIQCBtn">
        <span class="btn-icon">🔄</span>
        从IQC同步
      </button>
      <button class="btn btn-secondary" id="addVendorBtn">
        <span class="btn-icon">➕</span>
        添加供应商
      </button>
      <button class="btn btn-secondary" id="refreshBtn">
        <span class="btn-icon">🔄</span>
        刷新
      </button>
    </div>
  </div>

  <!-- 筛选区域 -->
  <div class="vendor-config__filter">
    <select id="sourceFilter">
      <option value="">全部来源</option>
      <option value="IQC">IQC数据</option>
      <option value="MANUAL">手动添加</option>
    </select>
    <select id="statusFilter">
      <option value="">全部状态</option>
      <option value="Active">启用</option>
      <option value="Inactive">停用</option>
    </select>
    <input type="text" id="searchInput" placeholder="搜索供应商名称">
  </div>

  <!-- 表格区域 -->
  <div class="vendor-config__table-container">
    <table class="vendor-config__table">
      <thead>
        <tr>
          <th><input type="checkbox" id="selectAll"></th>
          <th>供应商名称</th>
          <th>来源</th>
          <th>资料管理</th>
          <th>绩效评价</th>
          <th>状态</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="vendorTableBody">
        <!-- 动态生成 -->
      </tbody>
    </table>
  </div>

  <!-- 批量操作栏 -->
  <div class="vendor-config__batch-actions hidden">
    <button class="btn btn-primary" id="batchEnableDocument">
      批量启用资料管理
    </button>
    <button class="btn btn-primary" id="batchEnablePerformance">
      批量启用绩效评价
    </button>
    <button class="btn btn-danger" id="batchDelete">
      批量删除
    </button>
  </div>
</div>
```

### JavaScript架构

#### vendor-config.js（主管理器）
```javascript
class VendorConfigManager {
  constructor() {
    this.vendors = [];
    this.selectedVendors = new Set();
    this.filter = {
      source: '',
      status: '',
      keyword: ''
    };
  }

  async init() {
    window.vendorConfigManager = this;
    await this.loadVendors();
    this.bindEvents();
    this.render();
  }

  async loadVendors() {
    const response = await fetch('/api/vendors/config');
    const data = await response.json();
    if (data.success) {
      this.vendors = data.data;
    }
  }

  async syncFromIQC() {
    const response = await fetch('/api/vendors/sync-from-iqc', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mode: 'full' })
    });
    const data = await response.json();
    if (data.success) {
      await this.loadVendors();
      this.render();
    }
  }

  render() {
    // 渲染表格
  }
}
```

#### vendor-config-services.js（服务层）
```javascript
class VendorConfigServices {
  async getConfig(filters = {}) {
    // 获取配置列表
  }

  async updateConfig(id, config) {
    // 更新配置
  }

  async syncFromIQC(mode) {
    // 从IQC同步
  }

  async addVendor(vendorData) {
    // 添加供应商
  }

  async deleteVendor(id) {
    // 删除供应商
  }
}

window.vendorConfigServices = new VendorConfigServices();
```

#### vendor-config-ui-utils.js（UI工具层）
```javascript
class VendorConfigUIUtils {
  constructor() {
    if (!window.vendorConfigServices) {
      throw new Error('VendorConfigUIUtils 依赖 VendorConfigServices');
    }
  }

  showToast(message, type = 'success') {
    // 显示提示消息
  }

  showModal(content) {
    // 显示模态框
  }

  formatDate(date) {
    // 格式化日期
  }
}

window.vendorConfigUIUtils = new VendorConfigUIUtils();
```

### CSS文件结构
采用多文件拆分方案，与现有供应商模块的CSS组织方式保持一致：

```
public/css/modules/
├── vendor-config-components.css      # 通用组件（按钮、复选框、徽章等）
├── vendor-config-layout.css          # 布局样式（容器、表格、筛选区域等）
├── vendor-config-interactions.css    # 交互样式（悬停效果、动画等）
├── vendor-config-modals.css          # 模态框样式
├── vendor-config-font-hierarchy.css  # 字体层级管理
└── vendor-config-filter.css          # 筛选界面样式
```

**文件职责说明**：

- **vendor-config-components.css**：按钮、复选框、状态徽章等可复用组件
- **vendor-config-layout.css**：页面布局、表格结构、容器样式
- **vendor-config-interactions.css**：悬停效果、点击反馈、动画
- **vendor-config-modals.css**：添加/编辑供应商的模态框
- **vendor-config-font-hierarchy.css**：字体大小、行高、颜色层级
- **vendor-config-filter.css**：筛选区域、搜索框样式

**优点**：
1. 符合单一职责原则
2. 便于维护和查找
3. 与现有代码风格一致
4. 便于团队协作

---

## 实施步骤

### 阶段1：创建配置中心（不影响现有功能）- 4小时

#### 1.1 数据库迁移（30分钟）
- 创建`server/migrations/create_vendor_config.js`
- 执行迁移脚本创建vendor_config表
- 验证表结构正确性

#### 1.2 创建数据模型（30分钟）
- 创建`server/models/VendorConfig.js`
- 定义字段：id, supplier_name, source, enable_document_mgmt, enable_performance_mgmt, status, created_at, updated_at
- 添加索引优化查询性能

#### 1.3 创建同步服务（1小时）
- 创建`server/services/vendor-sync-service.js`
- 实现从IQCData提取供应商名称
- 实现供应商去重逻辑
- 实现增量/全量同步模式

#### 1.4 创建API路由（1小时）
- 创建`server/routes/vendors.js`
- 实现配置CRUD接口
- 实现从IQC同步接口
- 实现批量操作接口

#### 1.5 创建前端界面（1小时）
- 修改`public/index.html`添加配置中心模块容器
- 创建`public/js/modules/vendor-config.js`
- 创建`public/js/modules/vendor-config-services.js`
- 创建`public/js/modules/vendor-config-ui-utils.js`
- 创建6个CSS文件：
  - `public/css/modules/vendor-config-components.css`
  - `public/css/modules/vendor-config-layout.css`
  - `public/css/modules/vendor-config-interactions.css`
  - `public/css/modules/vendor-config-modals.css`
  - `public/css/modules/vendor-config-font-hierarchy.css`
  - `public/css/modules/vendor-config-filter.css`

#### 1.6 测试验证（30分钟）
- 测试从IQC同步供应商
- 测试手动添加供应商
- 测试配置更新
- 测试筛选和搜索功能

### 阶段2：切换供应商资料管理数据源 - 2小时

#### 2.1 修改API路由（1小时）
- 修改`server/routes/suppliers.js`的GET /api/suppliers/documents-summary
- 将数据源从suppliers表改为vendor_config表
- 添加查询条件：WHERE enable_document_mgmt = 1
- 移除所有IQC数据获取逻辑

#### 2.2 修改前端调用（30分钟）
- 修改`public/js/modules/supplier.js`
- 确保API调用路径正确
- 测试数据获取

#### 2.3 测试验证（30分钟）
- 测试供应商资料管理功能
- 验证只显示已启用资料管理的供应商
- 验证资料上传功能正常

### 阶段3：为绩效评价模块提供数据支持 - 3小时

#### 3.1 创建绩效评价API（1.5小时）
- 创建`server/routes/performance.js`
- 实现GET /api/vendors/active/performance接口
- 实现绩效数据计算逻辑
- 关联IQC质量数据

#### 3.2 创建绩效评价前端（1.5小时）
- 创建绩效评价模块界面
- 从配置中心获取供应商列表
- 展示绩效数据

#### 3.3 测试验证（1小时）
- 测试绩效评价功能
- 验证只显示已启用绩效评价的供应商
- 验证数据计算正确性

### 阶段4：清空重建（可选）- 1小时

#### 4.1 数据迁移（30分钟）
- 创建`server/migrations/migrate-to-vendor-config.js`
- 将现有Supplier表数据迁移到vendor_config表
- 清空Supplier表

#### 4.2 验证数据（30分钟）
- 验证数据迁移完整性
- 测试所有功能正常

---

## 测试计划

### 单元测试

#### 模型测试
```javascript
// 测试VendorConfig模型
describe('VendorConfig Model', () => {
  test('应该创建新的供应商配置', async () => {
    const config = await VendorConfig.create({
      supplier_name: '测试供应商',
      source: 'MANUAL',
      enable_document_mgmt: true,
      enable_performance_mgmt: false
    });
    expect(config.supplier_name).toBe('测试供应商');
  });

  test('应该验证供应商名称唯一性', async () => {
    await VendorConfig.create({
      supplier_name: '重复供应商',
      source: 'MANUAL'
    });
    await expect(
      VendorConfig.create({
        supplier_name: '重复供应商',
        source: 'MANUAL'
      })
    ).rejects.toThrow();
  });
});
```

#### 服务测试
```javascript
// 测试vendor-sync-service
describe('VendorSyncService', () => {
  test('应该从IQC数据提取供应商', async () => {
    const suppliers = await vendorSyncService.extractSuppliers(iqcData);
    expect(suppliers.length).toBeGreaterThan(0);
  });

  test('应该去重供应商', async () => {
    const uniqueSuppliers = await vendorSyncService.deduplicateSuppliers(duplicateSuppliers);
    expect(uniqueSuppliers.length).toBeLessThan(duplicateSuppliers.length);
  });
});
```

### 集成测试

#### 数据流测试
```javascript
describe('完整数据流测试', () => {
  test('IQC上传 → 同步到配置中心 → 显示在资料管理', async () => {
    // 1. 上传IQC数据
    await uploadIQCFile(testFile);

    // 2. 从IQC同步到配置中心
    await syncFromIQC();

    // 3. 启用资料管理
    await updateVendorConfig(vendorId, { enable_document_mgmt: true });

    // 4. 获取资料管理供应商列表
    const response = await fetch('/api/suppliers/documents-summary');
    const data = await response.json();

    expect(data.data.length).toBeGreaterThan(0);
  });
});
```

### UI测试

#### 界面功能测试
- 测试配置中心页面加载
- 测试供应商列表显示
- 测试筛选功能
- 测试批量操作
- 测试模态框显示

### 性能测试

#### 响应时间测试
- 配置列表查询 < 500ms
- 从IQC同步 < 2s（100个供应商）
- 批量更新 < 1s（10个供应商）

---

## 风险控制

### 数据备份
- 在执行迁移前备份现有数据库
- 保留Supplier表作为后备
- 提供回滚脚本

### 分阶段验证
- 每个阶段完成后进行充分测试
- 确保功能正常后再进行下一阶段
- 保留原有API作为后备

### 错误处理
- 添加详细的日志记录
- 提供友好的错误提示
- 实现事务回滚机制

### 兼容性
- 保留Supplier表结构不变
- 保留原有API接口
- 支持渐进式迁移

### 端口占用问题处理
**问题现象**：服务器启动时报错 `Error: listen EADDRINUSE: address already in use :::8888`

**处理流程**：
1. 查找占用端口的进程PID：
   ```cmd
   netstat -ano | findstr :8888
   ```
2. 通知用户PID和关闭命令：
   ```cmd
   taskkill /F /PID <PID>
   ```
3. 用户手动关闭进程后，重新启动服务器

**注意事项**：
- 不要擅自执行taskkill命令
- 必须先通知用户，由用户决定是否关闭
- 确认用户已关闭进程后再重新启动服务器

---

## 关键文件清单

### 后端文件（8个）
- `server/models/VendorConfig.js`（新建）
- `server/routes/vendors.js`（新建）
- `server/routes/performance.js`（新建）
- `server/services/vendor-sync-service.js`（新建）
- `server/routes/suppliers.js`（修改）
- `server/database/config.js`（修改）
- `server/index.js`（修改）
- `server/migrations/create_vendor_config.js`（新建）

### 前端文件（9个）
- `public/index.html`（修改）
- `public/js/modules/vendor-config.js`（新建）
- `public/js/modules/vendor-config-services.js`（新建）
- `public/js/modules/vendor-config-ui-utils.js`（新建）
- `public/css/modules/vendor-config-components.css`（新建）
- `public/css/modules/vendor-config-layout.css`（新建）
- `public/css/modules/vendor-config-interactions.css`（新建）
- `public/css/modules/vendor-config-modals.css`（新建）
- `public/css/modules/vendor-config-font-hierarchy.css`（新建）
- `public/css/modules/vendor-config-filter.css`（新建）
- `public/js/modules/supplier.js`（修改）

### 迁移脚本（2个）
- `server/migrations/create_vendor_config.js`（新建）
- `server/migrations/migrate-to-vendor-config.js`（新建）

---

## 预期成果

### 功能成果
1. 配置中心独立运行，不影响现有功能
2. 供应商资料管理只显示已配置的供应商
3. 绩效评价模块可以获取可控的供应商列表
4. 支持从IQC自动同步和手动添加供应商

### 技术成果
1. 清晰的代码架构，遵循单一职责原则
2. 完善的错误处理和日志记录
3. 符合BEM规范的CSS代码
4. 完整的测试覆盖

### 用户体验
1. 直观的配置界面
2. 快速的响应速度
3. 友好的错误提示
4. 灵活的批量操作

---

## 后续优化

### 短期优化（1-2周）
1. 添加配置导出/导入功能
2. 添加供应商标签功能
3. 优化批量操作性能
4. 添加操作日志记录

### 长期优化（1-3个月）
1. 支持更多模块配置
2. 实现配置版本管理
3. 添加配置审批流程
4. 实现供应商生命周期管理