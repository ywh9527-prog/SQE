# SQE供应商资料管理系统实施计划

**版本**: v2.0 | **创建日期**: 2025-11-29 | **基于**: SQE System v2.0 Architecture

---

## 🎯 项目概述

### 系统定位
在现有SQE数据分析系统基础上，集成供应商质量资料管理功能，实现SQE部门对供应商质量相关资质资料的统一管理和监控。

### 核心目标
- **统一平台**: 将供应商资料管理无缝集成到现有SQE系统
- **专业专注**: 专注于质量相关资料管理（质保协议、环保资料等）
- **智能预警**: 自动监控资料到期，多级预警机制
- **邮件自动化**: 标准化邮件模板，审核发送流程

---

## 🏗️ 技术架构设计

### 技术栈选择（基于现有系统）
- **前端**: HTML5 + CSS3 + JavaScript (ES6+) + Chart.js
- **后端**: Node.js + Express.js + Sequelize ORM + SQLite
- **认证**: JWT + bcryptjs
- **邮件**: nodemailer
- **文件存储**: multer + 本地文件系统

### 数据库模型设计

#### 1. 供应商资料表 (supplier_documents)
```sql
CREATE TABLE supplier_documents (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    supplier_id INTEGER NOT NULL,
    document_type ENUM('quality_agreement', 'environmental_rohs', 'environmental_reach', 'environmental_msds') NOT NULL,
    document_name VARCHAR(255) NOT NULL,
    document_number VARCHAR(100), -- 协议编号/证书编号
    file_path VARCHAR(500) NOT NULL,
    file_size INTEGER NOT NULL,
    upload_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    expiry_date DATETIME,
    status ENUM('active', 'expired', 'archived') DEFAULT 'active',
    responsible_person VARCHAR(100),
    issuing_authority VARCHAR(100), -- 发证机构
    remarks TEXT,
    version INTEGER DEFAULT 1,
    is_current BOOLEAN DEFAULT true,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (supplier_id) REFERENCES suppliers(id)
);
```

#### 3. 邮件通知表 (email_notifications)
```sql
CREATE TABLE email_notifications (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    document_id INTEGER NOT NULL,
    notification_type ENUM('warning_30d', 'warning_15d', 'warning_7d', 'expired', 'custom') NOT NULL,
    recipient_email VARCHAR(100) NOT NULL,
    subject VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    sent_at DATETIME,
    reply_received_at DATETIME,
    reply_status ENUM('pending', 'received', 'resolved') DEFAULT 'pending',
    approved_by INTEGER, -- 审核人
    approved_at DATETIME, -- 审核时间
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (document_id) REFERENCES supplier_documents(id),
    FOREIGN KEY (approved_by) REFERENCES users(id)
);
```

#### 4. 系统日志表 (system_logs)
```sql
CREATE TABLE system_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    action VARCHAR(100) NOT NULL,
    resource_type VARCHAR(50), -- 'document', 'supplier', 'user'
    resource_id INTEGER,
    details TEXT,
    ip_address VARCHAR(45),
    user_agent TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

---

## 📋 详细实施计划

### Phase 3.1: 简化认证系统 (3天)

#### 3.1.1 基础认证模块开发
**目标**: 实现简单的基础登录功能，专注质量资料管理

| 任务 | 详细内容 | 文件位置 | 预估工时 |
|------|----------|----------|----------|
| **3.1.1.1** | 创建简单User模型 | `server/models/User.js` | 1小时 |
| **3.1.1.2** | 基础登录API接口 | `server/routes/auth.js` | 2小时 |
| **3.1.1.3** | 简单登录界面 | `public/pages/login.html` | 2小时 |
| **3.1.1.4** | 前端登录逻辑 | `public/js/auth.js` | 1小时 |

**技术要点**:
- 密码使用bcrypt加密存储（6位最小长度）
- 简单的session管理
- 登录失败5次锁定账户
- 无复杂权限控制，所有登录用户权限相同

### Phase 3.2: 供应商资料管理核心功能 (2周)

#### Phase 3.2: 供应商资料管理核心功能 (2周)
**目标**: 实现供应商资料的完整CRUD和文件管理（基于用户确认需求）

| 任务 | 详细内容 | 文件位置 | 预估工时 |
|------|----------|----------|----------|
| **3.2.1** | **资料数据模型** | 创建供应商资料、邮件通知、系统日志模型 | `server/models/SupplierDocument.js`<br>`server/models/EmailNotification.js`<br>`server/models/SystemLog.js` | 3小时 |
| **3.2.2** | **资料CRUD接口** | 开发资料增删改查、文件上传接口（100MB限制） | `server/routes/documents.js` | 6小时 |
| **3.2.3** | **供应商管理模块** | 创建供应商资料管理前端模块（版本管理） | `public/js/modules/supplier.js` | 8小时 |
| **3.2.4** | **资料管理界面** | 开发资料列表、详情、上传界面（卡片式布局） | `public/pages/documents.html` | 6小时 |
| **3.2.5** | **文件上传组件** | 实现拖拽上传、批量处理、PDF预览功能 | `public/js/utils/fileUpload.js` | 5小时 |
| **3.2.6** | **界面样式设计** | 设计资料管理界面样式，集成Mocha Mousse主题 | `public/css/modules/documents.css` | 4小时 |
| **3.2.7** | **侧边栏集成** | 修改现有侧边栏名称，添加资料管理入口 | `public/index.html` | 2小时 |
| **3.2.8** | **版本管理功能** | 实现资料历史版本管理和归档功能 | `server/services/versionService.js` | 3小时 |
| **3.2.9** | **文件预览组件** | 实现PDF和图片文件预览功能 | `public/js/utils/filePreview.js` | 3小时 |

**核心功能**:
- 文件拖拽上传
- 批量文件处理
- 文件预览功能
- 资料版本管理
- 搜索和筛选

#### 3.2.2 UI界面集成
**目标**: 无缝集成到现有SQE系统界面

**界面布局设计**:
```
现有侧边栏扩展:
├── 📊 IQC数据分析 (现有)
├── 📋 供应商资料管理 (新增)
│   ├── 📄 资料概览
│   ├── 📁 质保协议
│   ├── 🌱 环保资料-ROHS
│   ├── 🌱 环保资料-REACH
│   └── 🌱 环保资料-MSDS
└── 📈 绩效评价 (规划中)
```

### Phase 3.3: 预警邮件系统 (2周)

#### 3.3.1 邮件服务集成
**目标**: 实现自动化的邮件通知系统（基于用户确认需求）

| 任务 | 详细内容 | 文件位置 | 预估工时 |
|------|----------|----------|----------|
| **3.3.1.1** | 配置nodemailer服务 | `server/services/emailService.js` | 3小时 |
| **3.3.1.2** | 创建邮件模板系统（含所有必需信息） | `server/templates/emails/` | 4小时 |
| **3.3.1.3** | 开发预警检测逻辑（30/15/7天+自定义） | `server/services/alertService.js` | 6小时 |
| **3.3.1.4** | 实现定时任务调度 | `server/jobs/expiryCheck.js` | 3小时 |
| **3.3.1.5** | 邮件审核发送流程（责任人审核） | `public/js/modules/notification.js` | 5小时 |
| **3.3.1.6** | 通知历史管理界面 | `public/pages/notifications.html` | 4小时 |
| **3.3.1.7** | 供应商回复处理 | `server/services/replyProcessor.js` | 5小时 |
| **3.3.1.8** | 自定义预警功能 | `server/services/customAlertService.js` | 3小时 |

**预警机制设计**:
```javascript
// 预警时间节点
const WARNING_LEVELS = {
  CRITICAL: 7,    // 7天内到期 - 红色预警
  URGENT: 15,     // 15天内到期 - 橙色预警
  WARNING: 30,    // 30天内到期 - 黄色预警
  EXPIRED: 0      // 已过期 - 灰色标记
};
```

#### 3.3.2 邮件模板设计
**质保协议续签提醒**:
```
主题：【重要】供应商{供应商名称}质保协议即将到期提醒

尊敬的{联系人}：
    
您好！根据系统记录，贵司与我司签订的质量保证协议将于{到期日期}到期。
为确保供应链质量管理的连续性，请尽快安排续签事宜。

协议详情：
- 供应商：{供应商名称}
- 协议编号：{协议编号}
- 到期日期：{到期日期}
- 负责人：{责任人}

请在{提醒日期}前完成续签并将新协议发送至：{接收邮箱}

如有疑问，请联系：
品质部：{品质部联系方式}
采购部：{采购部联系方式}

此邮件系统自动发送，请勿直接回复。
```

### Phase 3.4: 系统集成与优化 (1周)

#### 3.4.1 数据关联与统计
**目标**: 实现资料管理与IQC数据的关联分析

| 功能 | 描述 | 实现方式 |
|------|------|----------|
| **供应商资料完整性** | 统计各供应商资料齐全度 | JOIN查询suppliers和supplier_documents |
| **资料到期分布** | 按月份统计到期资料数量 | GROUP BY expiry_date月份 |
| **预警响应率** | 统计邮件预警后的回复率 | 计算reply_status为resolved的比例 |
| **质量关联分析** | 资料完整性与IQC合格率关联 | 关联IQC数据和资料状态 |

#### 3.4.2 性能优化
**优化重点**:
- 文件上传进度显示
- 大文件分片上传
- 资料列表虚拟滚动
- 邮件发送队列管理

---

## 🎨 UI/UX设计规范

### 设计原则
- **一致性**: 保持与现有SQE系统相同的Mocha Mousse主题
- **响应式**: 支持桌面端和移动端访问
- **可访问性**: 符合WCAG 2.1 AA标准
- **效率优先**: 减少用户操作步骤，提高工作效率

### 界面组件设计

#### 1. 登录界面
```css
.login-container {
  background: linear-gradient(135deg, var(--primary-500), var(--primary-700));
  /* 现代化登录卡片设计 */
}

.role-selector {
  display: flex;
  gap: 20px;
  /* 品质端/采购端角色选择 */
}
```

#### 2. 资料管理界面
```css
.document-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
  /* 卡片式资料展示 */
}

.document-card {
  border: 1px solid var(--primary-300);
  border-radius: 8px;
  /* 悬浮效果和状态指示 */
}
```

#### 3. 预警通知界面
```css
.alert-timeline {
  /* 时间线样式展示预警历史 */
}

.status-badge {
  /* 状态徽章：正常/临期/过期 */
}
```

---

## 🔄 开发时间线

### 第1周：简化认证和资料管理
- **Day 1-2**: 简单用户认证系统
- **Day 3-4**: 供应商资料模型和CRUD接口
- **Day 5**: 基础资料管理界面

### 第2周：文件管理和预警
- **Day 6-7**: 文件上传和预览功能
- **Day 8-9**: 邮件服务和模板系统
- **Day 10**: 预警检测和定时任务

### 第3周：系统集成和优化
- **Day 11-12**: 邮件审核流程和通知管理
- **Day 13-14**: 界面集成和响应式适配
- **Day 15**: 性能优化和测试

---

## 🧪 测试策略

### 功能测试
- **认证流程**: 登录、登出、权限验证
- **资料管理**: CRUD操作、文件上传、搜索筛选
- **预警系统**: 到期检测、邮件发送、状态更新
- **权限控制**: 角色访问限制、功能权限验证

### 性能测试
- **文件上传**: 大文件上传性能和稳定性
- **并发访问**: 多用户同时操作的系统响应
- **邮件发送**: 批量邮件发送的队列处理

### 安全测试
- **认证安全**: 密码加密、token安全、会话管理
- **文件安全**: 文件类型验证、路径安全、访问控制
- **数据安全**: SQL注入防护、XSS防护

---

## 📊 成功指标

### 功能指标
- ✅ 用户登录成功率 > 99%
- ✅ 文件上传成功率 > 95%
- ✅ 预警邮件发送成功率 > 98%
- ✅ 资料到期预警准确率 = 100%

### 性能指标
- ✅ 页面加载时间 < 2秒
- ✅ 文件上传速度 > 1MB/s
- ✅ 邮件发送延迟 < 30秒
- ✅ 系统并发支持 > 50用户

### 用户体验指标
- ✅ 用户操作步骤减少 > 30%
- ✅ 资料查找时间 < 10秒
- ✅ 系统易用性评分 > 4.5/5
- ✅ 用户满意度 > 90%

---

## 🚀 部署策略

### 开发环境
- 本地SQLite数据库
- 开发邮件服务器配置
- 热重载开发模式

### 生产环境
- 数据库备份策略
- 邮件服务器配置
- 日志监控和告警
- 定时任务调度

### 迁移计划
1. **数据备份**: 完整备份现有系统数据
2. **数据库升级**: 执行数据库结构变更脚本
3. **功能验证**: 逐步验证新功能正常
4. **用户培训**: 提供操作手册和培训
5. **正式上线**: 切换到新版本系统

---

## 📝 风险评估与应对

### 技术风险
| 风险 | 概率 | 影响 | 应对措施 |
|------|------|------|----------|
| 文件存储空间不足 | 中 | 高 | 实现文件压缩和清理机制 |
| 邮件发送失败 | 低 | 高 | 多重邮件服务商备选方案 |
| 数据库性能瓶颈 | 中 | 中 | 数据库优化和索引优化 |

### 业务风险
| 风险 | 概率 | 影响 | 应对措施 |
|------|------|------|----------|
| 用户接受度低 | 中 | 高 | 充分的用户培训和操作指南 |
| 权限配置错误 | 低 | 高 | 详细的权限测试和验证 |
| 资料数据丢失 | 低 | 极高 | 多重备份和恢复机制 |

---

## 📚 维护计划

### 日常维护
- 系统日志监控和清理
- 数据库性能监控
- 邮件队列状态检查
- 文件存储空间管理

### 定期维护
- 每月数据备份和恢复测试
- 每季度安全漏洞扫描
- 每半年系统性能评估
- 每年用户需求调研和功能优化

---

---

## 🔐 认证系统实施总结

### 📋 实施日期
2025年11月29日

### 🔍 遇到的问题及解决方案

#### 1. bcryptjs参数错误
- **问题**：`bcrypt.hash()` 缺少 saltRounds 参数，返回 "Illegal arguments: string, undefined"
- **解决**：添加第二个参数 `10`，即 `bcrypt.hash('123456', 10)`

#### 2. 认证API 404错误
- **问题**：路由正确注册但API返回404
- **原因**：旧的Node.js进程仍在运行，占用8888端口
- **解决**：停止所有旧进程 `Stop-Process -Id <PID> -Force`

#### 3. Express Router注册失败
- **问题**：`app.use('/api', authRoutes)` 不生效
- **原因**：单独的路由文件可能存在循环依赖或加载问题
- **解决**：直接在 `server/index.js` 中定义认证路由，而不使用单独文件

#### 4. 进程管理冲突
- **问题**：多次停止进程导致对话窗口关闭
- **解决**：使用精确的PID管理，避免全局 `taskkill /f /im node.exe`

#### 5. 前端认证检查缺失
- **问题**：用户可以直接访问主页，无需登录
- **解决**：在 `app.js` 中添加认证检查逻辑

### 🛠️ 实施步骤总结

#### Step 1: 依赖管理
```bash
npm install bcryptjs jsonwebtoken --save
```
- 立即测试每个包确保正常工作

#### Step 2: 数据模型
- 创建 `User.js` 模型
- 测试数据创建和查询功能

#### Step 3: 认证服务
- 创建简化的 `AuthService.js`
- 移除复杂的锁机制
- 使用固定JWT密钥和30天有效期

#### Step 4: API路由
- 直接在 `server/index.js` 中定义路由
- 实现 `/init`, `/login`, `/verify`, `/me` 端点

#### Step 5: 前端界面
- 创建简洁的登录页面
- 实现表单验证和错误处理

#### Step 6: 集成认证
- 修改主页面添加认证检查
- 添加用户信息显示和登出功能

### 💡 关键经验

1. **分步验证**：每个组件独立测试后再集成
2. **避免进程冲突**：精确管理PID，不使用全局命令
3. **简化设计**：移除不必要的复杂性
4. **直接集成**：遇到路由问题时，直接在主文件中定义

### 🎯 最终成果

- ✅ JWT令牌认证系统
- ✅ bcrypt密码加密
- ✅ 30天有效期
- ✅ 美观的登录界面
- ✅ 自动跳转和登出功能
- ✅ 完整的错误处理

## 📝 维护计划

### 日常维护
- 系统日志监控和清理
- 数据库性能监控
- 邮件队列状态检查
- 文件存储空间管理

### 定期维护
- 每月数据备份和恢复测试
- 每季度安全漏洞扫描
- 每半年系统性能评估
- 每年用户需求调研和功能优化

---

**文档维护**: 本计划将根据开发进度持续更新，确保与实际实施情况保持一致。
**最后更新**: 2025-11-28